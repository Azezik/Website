# Keyword constellation integration feasibility

## Where the current system differs
- **Scoped keywords only:** Config relations come only from keywords whose category matches the field key inside `KEYWORD_RELATION_SCOPE`, then keep a mother + up to 3 secondaries within a 35% page-diagonal radius, scoring left/above bias and size similarity; non-keyword tokens near the box are ignored. 【F:invoice-wizard.js†L7050-L7121】
- **Offsets are single-hop:** Each stored relation carries one offset from the keyword box to the value box; run mode reprojections and weighting use only those offsets (no token-to-token graph). 【F:invoice-wizard.js†L7091-L7121】【F:tools/keyword-weighting.js†L42-L94】
- **Triangulation blends with the config box:** Runtime seeds a centroid from the mother, any secondaries, and the saved config box (config weight defaults to 1.2), then scores candidates near that hint; there is no multi-token constellation matching today. 【F:tools/keyword-weighting.js†L117-L162】

## How the proposed constellation fits (and what needs to change)
- **Coordinate space aligns:** Both systems already store normalized page coordinates, so storing token centers and deltas is compatible. The current distance gating (35% of page diagonal) matches your initial search radius; the proposed expansion to 50% would need an opt-in radius increase.
- **Token collection must widen:** To build constellations you would need to capture the top N nearby tokens (by distance from the field origin) regardless of keyword category, not just label keywords. That means adding a config-time pass that indexes raw OCR tokens near the user box and persists their normText, centers, and deltas to the field; keyword categories stay as hints, not gates, when matching supports.
- **Graph edges are new:** The stored structure would need field→token and anchor→support (plus optional support↔support) deltas instead of the current single keyword→value offsets. Runtime matching would iterate anchor candidates and apply tolerance checks on each edge, rather than today’s per-keyword best-match scoring.
- **Scoring model diverges:** The current scoring mixes proximity, text similarity, and size alignment and falls back to the saved box if keywords are weak. A constellation port would instead score integer edge matches within tolerance (explicitly allowing partial K-of-N matches) and pick the best-fitting constellation, then project the field box strictly from the stored field→anchor delta before blending with the config box for fallback.
- **Anchor-first, not box-first:** Anchor candidates are evaluated on edge agreement, not on closeness to the saved config box, so repeated blocks elsewhere on a page can still win. The predicted field box from the winning constellation can then be merged with the existing triangulation stack for continuity with today’s signals.
- **Optional multi-hit output:** Keep the matcher capable of returning a ranked list of top-scoring constellations (defaulting to 1) so repeated sections can be supported later without redesign.
- **Catalogue growth is additive:** Increasing the keyword scan list to surface more nearby candidates is compatible, but the constellation matcher would rely primarily on geometric deltas; keyword categories would become optional hints rather than the gating filter used today.

## Practical integration path
1. **Capture phase:** During config, alongside `computeKeywordRelationsForConfig`, collect the nearest N tokens around the field origin (start at 35% diagonal, expand to 50% if needed). Store their normText, centers, and all requested deltas (field→token, anchor→support, optional cross-links) using normalized coordinates.
2. **Match phase (anchor-first):** In run mode, for each stored constellation: iterate every live instance of the stored anchor normText, greedily match supports using delta tolerance, and score by how many edges land within tolerance (K-of-N). Proximity to the saved config box does not suppress a better-fitting anchor elsewhere. Pick the highest-scoring constellation (optionally keep a ranked list for multi-hit), then reconstruct the field origin solely via the stored field→anchor delta.
3. **Blend with existing hints:** Feed the predicted box into the current triangulation/weighting stack so it cooperates with saved bbox, ring fingerprints, and existing keyword weighting instead of replacing them outright; blending happens after the constellation-driven reconstruction.
4. **Debuggability:** Keep integer scores and per-edge deltas in logs (mirroring today’s keyword relation debug output) so mismatches can be traced.

This approach preserves the current coordinate conventions while adding the constellation graph you described; the main required code changes are broadening token capture beyond scoped keywords and swapping the single-hop keyword matcher for the proposed edge-tolerant graph matcher.

## Implementation snapshot
- **Config capture:** `KeywordConstellation.captureConstellation` now records the nearest five tokens around every static field selection (regardless of keyword scope), storing normText, centers, field→token and anchor→support deltas, and optional support cross-links using normalized coordinates. 【F:tools/keyword-constellation.js†L10-L114】
- **Anchor-first matching:** At run time `KeywordConstellation.matchConstellation` iterates every live anchor candidate, greedily assigns supports within the configured delta tolerance (K-of-N edges), tallies matched edges, and reconstructs the field box from the stored field→anchor delta before any blending. 【F:tools/keyword-constellation.js†L116-L212】
- **Blending:** The reconstructed constellation box is injected as an extra seed into `KeywordWeighting.triangulateBox`, which still mixes in the saved config box (and keywords when present) to produce the triangulated search hint used by the extractor. 【F:tools/keyword-weighting.js†L117-L167】【F:invoice-wizard.js†L5058-L5086】
