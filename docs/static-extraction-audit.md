# Static extraction audit (config/run mismatch)

## What the green box should enforce
User selections in CONFIG mode are stored as normalized bboxes and later re-hydrated with `toPx(...)` and `applyTransform(...)`. Those helpers intentionally keep everything in logical (CSS/viewport) pixels and only apply rotation/scale, so the run-time box is expected to align with pdf.js token coordinates without a devicePixelRatio multiplier.【F:invoice-wizard.js†L776-L788】【F:invoice-wizard.js†L1060-L1076】

During RUN mode for static fields, `staticMinOverlap` drops the vertical overlap requirement to `0.5`, then the `attempt(...)` helper assembles tokens strictly inside the transformed box using that threshold. It cleans the text, fingerprints it, adjusts confidence by line-count similarity, and marks the attempt as usable only when cleaning or anchors succeed.【F:invoice-wizard.js†L2983-L2995】【F:invoice-wizard.js†L3107-L3231】

## Current hierarchy vs. desired pipeline
1. **BBox stage (Stage 0/1 equivalent):** The static resolver first runs `attempt(basePx)`. It immediately accepts when anchors pass, the fingerprint matches, and the observed line count matches (or is off by one) before any padding or search. This approximates the “raw user BBOX first” rule.【F:invoice-wizard.js†L3505-L3546】
2. **BBox padding:** If the initial attempt fails, the resolver expands the box by 4/8/12 px rings (4 px only in config) and retries until a cleaned candidate passes anchors. This means the engine can already move off the original green box before trying anchor delta logic.【F:invoice-wizard.js†L3552-L3559】
3. **Keyword delta:** Only after bbox/pads fail does the resolver try the keyword-delta stage, and only when keyword relations with a mother term exist. The delta shifts the original bbox by the observed “mother” keyword offset before re-running `attempt(...)`. If the profile lacks keyword relations or the mother keyword is missed, this stage is skipped, so the intended “second chance” is not always exercised.【F:invoice-wizard.js†L3599-L3709】
4. **Keyword triangulation (global fallback):** When still unresolved, keyword triangulation gathers nearby lines inside `MAX_KEYWORD_RADIUS` and ranks them by distance, keyword weight, anchors, fingerprint, and line-count score. It can replace the prior result when the best candidate beats the current score and passes static acceptance gates, allowing jumps away from the user box if earlier stages were empty.【F:invoice-wizard.js†L3252-L3363】【F:invoice-wizard.js†L3715-L3726】

## Vulnerabilities that can produce the observed misses
- **Padding before keyword delta:** Because padding tries up to 12 px in RUN mode ahead of the keyword delta step, the system can wander slightly and still lock onto a padded box result. If the padded box lands on neighboring text, triangulation never runs and the wrong value is “locked.” This deviates from the requested ordering where keyword delta should precede any broader search.【F:invoice-wizard.js†L3552-L3559】【F:invoice-wizard.js†L3713-L3726】
- **Anchor gating but low fingerprint tolerance:** `attempt(...)` reduces confidence sharply when fingerprints fail (`Math.max(0.2, baseConf * 0.6)`), yet bbox/anchor passes still mark the result as `cleanedOk`, letting padded or triangulated candidates override without showing the low-confidence warning. This can hide near-miss captures instead of surfacing the green-box text with a warning.【F:invoice-wizard.js†L3147-L3206】【F:invoice-wizard.js†L3258-L3308】
- **Keyword delta dependency:** The delta recovery only runs when `keywordRelations.mother` is present and matched on the page. Profiles lacking that setup skip the delta entirely and jump straight from padded bboxes to global triangulation, which matches the failure pattern shown in the screenshots (text in the selection ignored, unrelated candidate chosen).【F:invoice-wizard.js†L3599-L3709】
- **Line-count gating is soft after padding:** Stage 0/1 enforces exact/±1 line diff, but once the flow reaches padding or triangulation, lineDiff simply scales scores instead of blocking. A multi-line capture outside the selection can still outrank a one-line in-box value if distance or keyword weights are higher.【F:invoice-wizard.js†L3505-L3569】【F:invoice-wizard.js†L3258-L3363】

## Extraction symptoms vs. green-box text
- The screenshots show zero text extracted from the green boxes while the snapped (blue) boxes also fail. That aligns with the padding-first ordering: if the 12 px ring misses the intended lines due to small vertical drift or overlap tolerance, the resolver proceeds to keyword triangulation and may never revisit the exact user bbox with the keyword delta shift.
- Because triangulation allows candidates anywhere within `MAX_KEYWORD_RADIUS` and only requires `lineDiff <= 1` *or* a fingerprint match, distant text blocks can win when fingerprint codes or anchor heuristics misalign, explaining why unrelated lines appear in the final outputs.【F:invoice-wizard.js†L3252-L3363】【F:invoice-wizard.js†L3505-L3569】

## Recommended hardening (code-level targets)
- Move the keyword-delta stage ahead of any padding loops so the raw green-box position gets its keyword shift before the resolver leaves the user’s area.【F:invoice-wizard.js†L3552-L3559】【F:invoice-wizard.js†L3599-L3709】
- Treat fingerprint failures in `attempt(...)` as low-confidence but *visible* results (not `cleanedOk`), so the UI surfaces the green-box text with a warning instead of letting later candidates silently override it.【F:invoice-wizard.js†L3147-L3206】
- Tighten triangulation acceptance by requiring both `lineDiff <= 1` **and** fingerprint/anchor success for static fields, preventing faraway multi-line blocks from outranking the user selection when anchors are weak.【F:invoice-wizard.js†L3258-L3363】

## Latest debug trace (store/invoice/customer fields)
- **Store name**: The run locked at the padded bbox stage with anchors partially failing (left/right) but still within tolerance. Because the stored fingerprint already expected a two-line “Sales Date: 09 Nov 24” pattern, the mismatch was marked fingerprint-OK and never retried with keyword delta, so the green-box business name was skipped despite the wrong content passing acceptance gates.【F:invoice-wizard.js†L3505-L3569】【F:invoice-wizard.js†L3599-L3709】
- **Invoice number**: Anchors passed on the first padded attempt even though the candidate contained only labels (“Sales Bill:/Invoice:”). Fingerprint failure merely reduced confidence; the resolver kept the bbox winner and did not promote the keyword-relative triangulated box, letting label-only text survive as the final value.【F:invoice-wizard.js†L3147-L3206】【F:invoice-wizard.js†L3505-L3569】
- **Invoice date**: Multiple attempts inside and slightly outside the bbox latched onto neighboring label tokens (“Customer:”), because anchor tolerance treated left/right drift as OK and fingerprint acceptance on short label text allowed the mis-capture to be marked clean. The keyword-delta stage never ran (no relation configured), so the engine never re-centered on the original green box before locking.【F:invoice-wizard.js†L3147-L3206】【F:invoice-wizard.js†L3505-L3569】【F:invoice-wizard.js†L3599-L3709】
- **Customer name/address**: Both fields reused the same small OCR cluster (“K0A 2Z0”) because bbox overlap and line-count matched, but fingerprints failed. The resolver still locked the padded bbox attempt with reduced confidence, and keyword relations existed yet were not decisive enough to dislodge the incorrect padded box. This mirrors the “padding before keyword delta” vulnerability where nearby noise beats the intended green-box content.【F:invoice-wizard.js†L3147-L3206】【F:invoice-wizard.js†L3552-L3591】【F:invoice-wizard.js†L3599-L3709】
