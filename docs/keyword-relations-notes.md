# Keyword relation behavior notes

- The keyword catalogue and scoped relation set are hard-coded. Relations are only captured for field keys listed in `KEYWORD_RELATION_SCOPE`, regardless of the user-supplied display name. This includes `invoice_total`, so totals get keyword anchors even if a custom label like "pdfadh" is used. [See `invoice-wizard.js` definitions.]
- During config, `computeKeywordRelationsForConfig` searches the keyword index for matches in the same category as the field key. It scores each candidate by position bias (left of the value is strongest, above is next), normalized distance (within ~35% of the page diagonal), and font-size similarity, then picks the highest as the mother and the next three as secondaries. These offsets are stored relative to the value box.
- At run time, `KeywordWeighting.triangulateBox` re-finds mother/secondary keywords by applying the stored offsets to live keyword matches. It seeds a weighted centroid from the predicted boxes plus the saved config box (weight 1.2 by default), returning a triangulated search box even if only secondaries or the config box are available.
- `chooseKeywordMatch` uses text similarity, size alignment, and proximity to the saved box to rank live keyword matches. Matches outside the `MAX_KEYWORD_RADIUS` (35% of page diagonal) are ignored, ensuring nearby labels like "Total" outrank distant words such as "Deposit".
- If no live keyword matches are usable, extraction falls back to the saved bbox and anchor logic; keyword triangulation is additive and does not override the config box when empty.
